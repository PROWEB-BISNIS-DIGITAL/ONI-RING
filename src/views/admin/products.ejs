<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        .product-card {
            transition: all 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.2);
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
        }
        
        .modal-backdrop.show {
            display: flex !important;
        }

        .modal-content {
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 75%;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }

        .badge-active {
            background-color: #10b981;
            color: white;
        }

        .badge-inactive {
            background-color: #ef4444;
            color: white;
        }

        /* Notification Popup Styles */
        .notification-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            min-width: 300px;
            max-width: 400px;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
            opacity: 1;
        }

        .notification-success {
            background-color: #10b981;
            color: white;
            border-left: 4px solid #059669;
        }

        .notification-error {
            background-color: #ef4444;
            color: white;
            border-left: 4px solid #dc2626;
        }

        .notification-warning {
            background-color: #f59e0b;
            color: white;
            border-left: 4px solid #d97706;
        }

        .notification-info {
            background-color: #3b82f6;
            color: white;
            border-left: 4px solid #1d4ed8;
        }

        .notification-icon {
            font-size: 20px;
            margin-right: 12px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-message {
            font-size: 14px;
            line-height: 1.4;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* Confirmation Popup */
        .confirmation-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .confirmation-popup.show {
            display: flex;
        }

        .confirmation-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            animation: popupAppear 0.3s ease;
        }

        @keyframes popupAppear {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-gray-100">
    <%- include('./partialsAdmin/sidebar') %>

    <!-- Main Content -->
    <div class="flex-1 p-8">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Manajemen Produk</h1>
                <p class="text-gray-600 mt-2">Kelola semua produk yang tersedia di Cemal-Cemil</p>
            </div>
            <button onclick="showAddModal()" class="mt-4 md:mt-0 bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-semibold transition duration-300 shadow-md hover:shadow-lg flex items-center">
                <i class="fas fa-plus mr-2"></i>Tambah Produk Baru
            </button>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Produk</p>
                        <p class="text-2xl font-bold text-gray-800"><%= products.length %></p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-box text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Produk Aktif</p>
                        <p class="text-2xl font-bold text-green-600"><%= products.filter(p => p.status === 'active').length %></p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Nilai</p>
                        <p class="text-2xl font-bold text-red-600">Rp <%= products.reduce((sum, p) => sum + p.price, 0).toLocaleString('id-ID') %></p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-full">
                        <i class="fas fa-money-bill-wave text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search & Filter -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div class="w-full md:w-auto">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Cari produk..." class="w-full md:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                <div class="flex gap-3 w-full md:w-auto">
                    <select id="status-filter" class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="all">Semua Status</option>
                        <option value="active">Aktif</option>
                        <option value="inactive">Nonaktif</option>
                    </select>
                    <select id="category-filter" class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="all">Semua Kategori</option>
                        <option value="Makanan">Makanan</option>
                        <option value="Minuman">Minuman</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Product List -->
        <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <% if (products && products.length > 0) { %>
                <% products.forEach(function(product) { %>
                    <div class="product-card bg-white rounded-xl overflow-hidden border border-gray-100" data-status="<%= product.status %>" data-category="<%= product.category %>">
                        <div class="relative">
                            <img src="<%= product.image %>" alt="<%= product.name %>" class="w-full h-48 object-cover">
                            <div class="absolute top-3 right-3">
                                <span class="badge <%= product.status === 'active' ? 'badge-active' : 'badge-inactive' %>">
                                    <%= product.status === 'active' ? 'Aktif' : 'Nonaktif' %>
                                </span>
                            </div>
                            <div class="absolute top-3 left-3 flex space-x-2">
                                <button onclick="editProduct(<%= product.id %>)" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg transition duration-300">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="showDeleteModal(<%= product.id %>)" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg transition duration-300">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="absolute bottom-3 left-3 bg-black/70 text-white px-3 py-1 rounded-full text-sm font-semibold">
                                Rp <%= product.price.toLocaleString('id-ID') %>
                            </div>
                        </div>
                        <div class="p-5">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-lg font-bold text-gray-800"><%= product.name %></h3>
                                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">
                                    <%= product.category %>
                                </span>
                            </div>
                            <p class="text-gray-600 text-sm mb-4"><%= product.description || '-' %></p>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-500">
                                    ID: #<%= product.id.toString().padStart(3, '0') %>
                                </span>
                                <button onclick="showStatusConfirmation(<%= product.id %>, '<%= product.status %>', '<%= product.name %>')" class="text-sm <%= product.status === 'active' ? 'text-yellow-600 hover:text-yellow-700' : 'text-green-600 hover:text-green-700' %>">
                                    <i class="fas <%= product.status === 'active' ? 'fa-eye-slash' : 'fa-eye' %> mr-1"></i>
                                    <%= product.status === 'active' ? 'Nonaktifkan' : 'Aktifkan' %>
                                </button>
                            </div>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-box-open text-5xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Belum ada produk</h3>
                    <p class="text-gray-500 mb-6">Tambahkan produk pertama Anda dengan klik tombol "Tambah Produk Baru"</p>
                </div>
            <% } %>
        </div>
    </div>

    <!-- Modal Add/Edit Product -->
    <div id="product-modal" class="modal-backdrop fixed inset-0 z-50 overflow-y-auto flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="bg-red-500 text-white p-6 flex justify-between items-center">
                <h3 id="modal-title" class="text-2xl font-bold">Tambah Produk Baru</h3>
                <button onclick="hideModal()" class="text-white hover:text-gray-200 text-3xl">&times;</button>
            </div>

            <div class="p-6">
                <form id="product-form" class="space-y-6">
                    <input type="hidden" id="product-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Nama Produk *</label>
                            <input type="text" id="product-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Contoh: Onigiri Ayam Suwir">
                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Harga (Rp) *</label>
                            <input type="number" id="product-price" required min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Contoh: 7000">
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Deskripsi</label>
                        <textarea id="product-description" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Deskripsi produk..."></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Kategori</label>
                            <input type="text" id="product-category" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Contoh: Makanan">
                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Status *</label>
                            <select id="product-status" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                <option value="active">Aktif</option>
                                <option value="inactive">Nonaktif</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">URL Gambar</label>
                        <input type="text" id="product-image" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="https://example.com/image.jpg">
                        <p class="text-gray-500 text-sm mt-2">Biarkan kosong untuk menggunakan gambar default</p>
                    </div>

                    <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                        <button type="button" onclick="hideModal()" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-300 font-semibold">
                            Batal
                        </button>
                        <button type="submit" class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300 font-semibold shadow-md hover:shadow-lg">
                            <i class="fas fa-save mr-2"></i>Simpan Produk
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 mb-2">Hapus Produk</h3>
                    <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus produk ini? Tindakan ini tidak dapat dibatalkan.</p>
                    <div class="flex justify-center space-x-4">
                        <button onclick="hideDeleteModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-300">
                            Batal
                        </button>
                        <button onclick="confirmDelete()" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition duration-300 font-semibold">
                            Ya, Hapus
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Confirmation Popup -->
    <div id="status-confirmation" class="confirmation-popup">
        <div class="confirmation-content">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                    <i class="fas fa-exchange-alt text-yellow-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2" id="status-confirmation-title">Ubah Status Produk</h3>
                <p class="text-gray-600 mb-4" id="status-confirmation-message"></p>
                <div class="flex justify-center space-x-4">
                    <button onclick="hideStatusConfirmation()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-300">
                        Batal
                    </button>
                    <button onclick="confirmStatusChange()" class="px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition duration-300 font-semibold">
                        Ya, Ubah Status
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let productToDelete = null;
        let productToToggle = null;
        let currentStatus = null;
        let editingProductId = null;

        document.getElementById('product-modal').style.display = 'none';
        document.getElementById('delete-modal').style.display = 'none';

        function showAddModal() {
            editingProductId = null;
            document.getElementById('modal-title').textContent = 'Tambah Produk Baru';
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-status').value = 'active';
            document.getElementById('product-modal').classList.add('show');
        }

        function hideModal() {
            document.getElementById('product-modal').classList.remove('show');
        }

        function editProduct(id) {
            editingProductId = id;
            fetch(`/admin/products/${id}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const product = data.product;
                        document.getElementById('modal-title').textContent = 'Edit Produk';
                        document.getElementById('product-id').value = product.id;
                        document.getElementById('product-name').value = product.name;
                        document.getElementById('product-description').value = product.description || '';
                        document.getElementById('product-price').value = product.price;
                        document.getElementById('product-image').value = product.image;
                        document.getElementById('product-category').value = product.category || '';
                        document.getElementById('product-status').value = product.status;
                        document.getElementById('product-modal').classList.add('show');
                    }
                })
                .catch(err => {
                    console.error(err);
                    showNotification('Gagal memuat data produk', 'error');
                });
        }

        function showStatusConfirmation(id, status, productName) {
            productToToggle = id;
            currentStatus = status;
            const newStatus = status === 'active' ? 'nonaktif' : 'aktif';
            document.getElementById('status-confirmation-title').textContent = 'Ubah Status Produk';
            document.getElementById('status-confirmation-message').textContent = 
                `Ubah status produk "${productName}" menjadi ${newStatus}?`;
            document.getElementById('status-confirmation').classList.add('show');
        }

        function hideStatusConfirmation() {
            document.getElementById('status-confirmation').classList.remove('show');
        }

        function confirmStatusChange() {
            if (productToToggle) {
                fetch(`/admin/products/${productToToggle}/toggle-status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        hideStatusConfirmation();
                        setTimeout(() => location.reload(), 500);
                    } else {
                        showNotification(data.message, 'error');
                    }
                })
                .catch(err => {
                    console.error(err);
                    showNotification('Terjadi kesalahan', 'error');
                });
            }
        }

        function showDeleteModal(id) {
            productToDelete = id;
            document.getElementById('delete-modal').classList.add('show');
        }

        function hideDeleteModal() {
            productToDelete = null;
            document.getElementById('delete-modal').classList.remove('show');
        }

        function confirmDelete() {
            if (productToDelete) {
                fetch(`/admin/products/${productToDelete}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        hideDeleteModal();
                        setTimeout(() => location.reload(), 500);
                    } else {
                        showNotification(data.message, 'error');
                    }
                })
                .catch(err => {
                    console.error(err);
                    showNotification('Terjadi kesalahan', 'error');
                });
            }
        }

        document.getElementById('product-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value;
            const description = document.getElementById('product-description').value;
            const price = parseInt(document.getElementById('product-price').value);
            const image = document.getElementById('product-image').value;
            const category = document.getElementById('product-category').value;
            const status = document.getElementById('product-status').value;

            // Gunakan default image jika URL kosong
            const imageUrl = image || '/images/default-product.jpg';

            const data = { 
                name, 
                description, 
                price, 
                image: imageUrl, 
                category, 
                status 
            };

            const url = id ? `/admin/products/${id}` : '/admin/products';
            const method = id ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    hideModal();
                    setTimeout(() => location.reload(), 500);
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(err => {
                console.error(err);
                showNotification('Terjadi kesalahan', 'error');
            });
        });

        function showNotification(message, type = 'success') {
            const container = document.createElement('div');
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : '⚠️';
            const title = type === 'success' ? 'Berhasil!' : type === 'error' ? 'Error!' : 'Peringatan!';
            
            container.className = `notification-popup notification-${type}`;
            container.innerHTML = `
                <div class="notification-icon">${icon}</div>
                <div class="notification-content">
                    <div class="notification-message">${message}</div>
                </div>
            `;

            document.body.appendChild(container);

            // Remove notification after animation
            setTimeout(() => {
                if (container.parentNode) {
                    container.parentNode.removeChild(container);
                }
            }, 3000);
        }

        // Filter functionality
        document.getElementById('search-input').addEventListener('input', filterProducts);
        document.getElementById('status-filter').addEventListener('change', filterProducts);
        document.getElementById('category-filter').addEventListener('change', filterProducts);

        function filterProducts() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;

            document.querySelectorAll('.product-card').forEach(card => {
                const text = card.textContent.toLowerCase();
                const status = card.getAttribute('data-status');
                const category = card.getAttribute('data-category');

                const matchesSearch = searchTerm === '' || text.includes(searchTerm);
                const matchesStatus = statusFilter === 'all' || status === statusFilter;
                const matchesCategory = categoryFilter === 'all' || category === categoryFilter;

                if (matchesSearch && matchesStatus && matchesCategory) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Close modals when clicking outside
        document.getElementById('product-modal').addEventListener('click', function(e) {
            if (e.target.id === 'product-modal') hideModal();
        });

        document.getElementById('delete-modal').addEventListener('click', function(e) {
            if (e.target.id === 'delete-modal') hideDeleteModal();
        });

        document.getElementById('status-confirmation').addEventListener('click', function(e) {
            if (e.target.id === 'status-confirmation') hideStatusConfirmation();
        });
    </script>
</body>
</html>